<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전공 이상형 월드컵</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      text-align: center;
      font-size: 24px;
    }
    .hidden { display: none; }
    .input-container, .instruction, .category-select, .tournament, .result-area, .round-loading, .round-notice {
      margin-top: 50px;
    }
    .input-container input { font-size: 20px; padding: 8px; margin: 10px; }
    .card-container { display: flex; justify-content: center; gap: 40px; margin-top: 40px; }
    .card {
      flex: 1 1 30%;
      padding: 20px;
      border: 4px solid #ccc;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      box-sizing: border-box;
      min-width: 200px;
    }
    .major {
      font-size: 48px;
      font-weight: bold;
      color: black;
    }
    .friends {
      font-size: 18px;
      color: hotpink;
    }
    .button { font-size: 24px; padding: 12px 24px; margin: 10px; }
    .summary-table {
      margin: 30px auto;
      border-collapse: collapse;
      font-size: 20px;
      width: 90%;
    }
    .summary-table th, .summary-table td {
      border: 1px solid #888;
      padding: 10px;
      text-align: center;
    }
    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid pink;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="input-container" id="inputForm">
    <input id="school" placeholder="학교" />
    <input id="studentId" placeholder="학번" />
    <input id="studentName" placeholder="이름" />
    <button onclick="showInstructions()">다음</button>
  </div>

  <div id="instruction" class="instruction hidden">
    <p style="text-align: left; padding-left: 1.5em; white-space: pre-line">
① 이 프로그램은 대학 전공학과에 대한 자신의 관심 순위를 알아보기 위해 제작되었습니다.
② [인문+공통+체육], [자연+공통] 2개 카테고리 중에 하나를 선택하여 진행합니다.
③ 해당 계열의 전공학과가 쌍을 이루어 나타나면, 보다 관심이 있는 학과를 선택하기 바랍니다.
④ 64강부터 시작하며, [인문+공통+체육]은 무작위로 선택된 8개의 학과가 부전승으로 32강에 진출합니다.
⑤ 총 3번까지 결과를 저장하고 라운드를 진행할 수 있으며, 3라운드를 마치면 PDF 파일로 결과를 저장할 수 있습니다.
⑥ 준비가 되었다면 아래 계열을 선택하고 전공학과 이상형 월드컵을 시작해 주세요.
    </p>
    <div class="category-select">
      <button onclick="startGame('inmun')" class="button">인문+공통+체육</button>
      <button onclick="startGame('jayeon')" class="button">자연+공통</button>
    </div>
  </div>

  <div id="roundNotice" class="round-notice hidden">
    <div id="roundTitle" style="font-size: 48px; color: pink;"></div>
    <div class="spinner"></div>
  </div>

  <div id="tournament" class="tournament hidden"></div>

  <div id="resultArea" class="result-area hidden">
    <div id="summaryTree"></div>
    <button id="nextRoundBtn" class="button" onclick="nextRound()">결과 저장하고 한번 더!</button>
    <button id="pdfBtn" class="button hidden" onclick="downloadPDF()">PDF 저장</button>
  </div>

<script>
const SUPABASE_URL = 'https://vgnnzehkzbrsatdyoqzf.supabase.co';
const SUPABASE_KEY = 'ey...';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userInfo = { school: '', studentId: '', studentName: '' };
let roundResults = [], roundNumber = 1, currentTable = '', currentRoundData = [];

function showInstructions() {
  userInfo.school = document.getElementById('school').value.trim();
  userInfo.studentId = document.getElementById('studentId').value.trim();
  userInfo.studentName = document.getElementById('studentName').value.trim();
  if (!userInfo.school || !userInfo.studentId || !userInfo.studentName) {
    alert("모든 정보를 입력해 주세요."); return;
  }
  document.getElementById("inputForm").classList.add("hidden");
  document.getElementById("instruction").classList.remove("hidden");
}

async function startGame(tableName) {
  currentTable = tableName;
  const { data, error } = await supabaseClient.from(tableName).select('*');
  if (error || !data || data.length === 0) {
    alert("데이터 불러오기 실패"); return;
  }
  const majors = shuffleArray(data);
  if (tableName === 'inmun') {
    const bye = majors.slice(0, 8);
    const play = majors.slice(8, 56);
    currentRoundData = play;
    roundResults = [];
    roundNumber = 1;
    startTournament(bye);
  } else {
    currentRoundData = majors.slice(0, 64);
    roundResults = [];
    roundNumber = 1;
    startTournament([]);
  }
}

function startTournament(bye) {
  document.getElementById("instruction").classList.add("hidden");
  document.getElementById("roundNotice").classList.remove("hidden");
  document.getElementById("roundTitle").innerText = `${currentRoundData.length + bye.length}강 로딩 중...`;
  setTimeout(() => {
    document.getElementById("roundNotice").classList.add("hidden");
    document.getElementById("tournament").classList.remove("hidden");
    showTournament(bye);
  }, 2000);
}

function showTournament(bye) {
  const container = document.getElementById("tournament");
  container.innerHTML = "";
  const pairs = [];
  for (let i = 0; i < currentRoundData.length; i += 2) {
    pairs.push([currentRoundData[i], currentRoundData[i + 1]]);
  }
  let selected = [];

  function showPair(index) {
    if (index >= pairs.length) {
      currentRoundData = [...selected, ...bye];
      if (currentRoundData.length === 1) return showResult();
      roundResults.push([...selected]);
      roundNumber++;
      document.getElementById("tournament").classList.add("hidden");
      startTournament([]);
      return;
    }
    const [a, b] = pairs[index];
    container.innerHTML = '';
    const row = document.createElement('div');
    row.className = 'card-container';
    [a, b].forEach(cardData => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class='major'>${cardData.major}</div><div class='friends'>${cardData.friends}</div>`;
      card.onclick = () => { selected.push(cardData); showPair(index + 1); };
      row.appendChild(card);
    });
    container.appendChild(row);
  }
  showPair(0);
}

function showResult() {
  document.getElementById("tournament").classList.add("hidden");
  document.getElementById("resultArea").classList.remove("hidden");
  const tree = document.getElementById("summaryTree");

  if (roundResults.length === 1) {
    tree.innerHTML = `<h2>${userInfo.school} ${userInfo.studentId} ${userInfo.studentName} 님의 선택 결과</h2>`;
  }

  const last = roundResults[roundResults.length - 1];
  const final = last[0];
  const finals = last.slice(0, 2).filter(d => d.major !== final.major);
  const semis = last.slice(0, 4).filter(d => !last.slice(0, 2).includes(d));
  const quarters = last.slice(0, 8).filter(d => !last.slice(0, 4).includes(d));

  tree.innerHTML += `
    <table class='summary-table'>
      <tr><th colspan='2'>Round ${roundResults.length} 결과</th></tr>
      <tr><th>최종 우승</th><td>${final.major}</td></tr>
      <tr><th>결승 진출자</th><td>${finals.map(d => d.major).join(" / ")}</td></tr>
      <tr><th>4강 진출자</th><td>${semis.map(d => d.major).join(" / ")}</td></tr>
      <tr><th>8강 진출자</th><td>${quarters.map(d => d.major).join(" / ")}</td></tr>
    </table>`;

  document.getElementById("nextRoundBtn").classList.remove("hidden");
  document.getElementById("pdfBtn").classList.add("hidden");

  if (roundResults.length === 3) {
    document.getElementById("nextRoundBtn").classList.add("hidden");
    document.getElementById("pdfBtn").classList.remove("hidden");
  }
}

function nextRound() {
  roundNumber = 1;
  document.getElementById("resultArea").classList.add("hidden");
  document.getElementById("pdfBtn").classList.add("hidden");
  document.getElementById("nextRoundBtn").classList.add("hidden");
  startGame(currentTable);
}

function shuffleArray(arr) {
  return arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(v => v[1]);
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.html(document.body, {
    callback: function(doc) {
      doc.save(`${userInfo.studentId}_${userInfo.studentName}_결과.pdf`);
    }, x: 10, y: 10
  });
}
</script>
</body>
</html>
