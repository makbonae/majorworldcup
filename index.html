<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전공 이상형 월드컵</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link rel="icon" href="data:,">
  <style>
    body { font-size: 24px; font-family: sans-serif; text-align: center; margin: 0; background: #f9f9f9; }
    .major { font-size: 48px; font-weight: bold; color: black; }
    .friends { font-size: 18px; color: pink; }
    .hidden { display: none; }
    .instructions { margin: 50px 1.5em; text-align: left; white-space: pre-line; }
    button { font-size: 24px; margin: 10px; padding: 10px 20px; }
    table { margin: 10px auto; border-collapse: collapse; }
    td { border: 1px solid #ccc; padding: 10px; }
    #loading-text { font-size: 32px; font-weight: bold; color: hotpink; }
    .pair { display: flex; justify-content: center; gap: 50px; margin: 40px 0; }
    .card { width: 300px; height: 200px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 2px solid #ccc; border-radius: 10px; padding: 10px; box-sizing: border-box; }
  </style>
</head>
<body>
  <div id="start-screen">
    <p>학교: <input id="school"></p>
    <p>학번: <input id="studentId"></p>
    <p>이름: <input id="name"></p>
    <button onclick="startInput()">다음</button>
  </div>

  <div id="info-screen" class="hidden">
    <div class="instructions">
① 이 프로그램은 대학 전공학과에 대한 자신의 관심 순위를 알아보기 위해 제작되었습니다.
② [인문+공통+체육], [자연+공통] 2개 카테고리 중 하나를 선택하여 진행합니다.
③ 해당 계열의 전공학과가 쌍을 이루어 나타나면, 보다 관심 있는 학과를 선택하기 바랍니다.
④ 64강부터 시작하며, [인문+공통+체육]은 무작위로 선택된 8개의 학과가 부전승으로 32강에 진출합니다.
⑤ 총 3번까지 결과를 저장하고 라운드를 진행할 수 있으며, 3라운드를 마치면 PDF 파일로 결과를 저장할 수 있습니다.
⑥ 준비가 되었다면 아래 계열을 선택하고 전공학과 이상형 월드컵을 시작해 주세요.
    </div>
    <button onclick="startTournament('inmun')">인문+공통+체육</button>
    <button onclick="startTournament('jayeon')">자연+공통</button>
  </div>

  <div id="loading-screen" class="hidden">
    <div id="loading-text"></div>
  </div>

  <div id="tournament-screen" class="hidden">
    <div id="pair-container"></div>
  </div>

  <div id="result-screen" class="hidden">
    <div id="greeting"></div>
    <div id="results-tables"></div>
    <button onclick="repeatTournament()">결과 저장하고 한번 더!</button>
    <button id="pdfBtn" class="hidden" onclick="downloadPDF()">PDF 저장</button>
  </div>

  <script>
    let userInfo = {};
    let roundResults = [];
    let fullData = [];

    const { createClient } = supabase;
    const supabaseClient = createClient(
      'https://vgnnzehkzbrsatdyoqzf.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnbm56ZWhremJyc2F0ZHlvcXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzUyNTksImV4cCI6MjA2Njk1MTI1OX0.ANWPKzugvztZLkYm5P9og9ENF-SG4QcTi9s1RBOO1DA'
    );

    function startInput() {
      userInfo.school = document.getElementById('school').value;
      userInfo.studentId = document.getElementById('studentId').value;
      userInfo.name = document.getElementById('name').value;
      document.getElementById('start-screen').classList.add('hidden');
      document.getElementById('info-screen').classList.remove('hidden');
    }

    async function startTournament(table) {
      roundResults = [];
      document.getElementById('info-screen').classList.add('hidden');
      await showRoundLoading('64강');

      const { data, error } = await supabaseClient.from(table).select('*');

      if (error || !Array.isArray(data)) {
        alert('데이터 불러오기 실패: ' + (error?.message || '형식 오류'));
        return;
      }

      fullData = [...data];
      shuffle(fullData);

      if (table === 'inmun') {
        const bye = fullData.splice(0, 8);
        const matches = [];
        for (let i = 0; i < 48; i += 2) matches.push([fullData[i], fullData[i + 1]]);
        const winners = await doPairSelection(matches);
        fullData = [...bye, ...winners];
      }

      await runRounds(fullData);
    }

    async function runRounds(items) {
      const labels = ['64강', '32강', '16강', '8강', '4강', '결승'];
      let current = [...items];

      for (let i = 0; i < labels.length; i++) {
        await showRoundLoading(labels[i]);
        const matches = [];
        for (let j = 0; j < current.length; j += 2) matches.push([current[j], current[j + 1]]);
        current = await doPairSelection(matches);
        saveRoundResult(labels[i], current);
      }
      saveRoundResult('최종 선택', current);
      showResults();
    }

    function showRoundLoading(label) {
      return new Promise(res => {
        document.getElementById('loading-text').innerText = `${label} 로딩중...`;
        document.getElementById('loading-screen').classList.remove('hidden');
        document.getElementById('tournament-screen').classList.add('hidden');
        setTimeout(() => {
          document.getElementById('loading-screen').classList.add('hidden');
          res();
        }, 2000);
      });
    }

    function saveRoundResult(label, items) {
      roundResults.push({ roundName: label, items: [...items] });
    }

    function doPairSelection(pairs) {
      return new Promise(async resolve => {
        document.getElementById('pair-container').innerHTML = '';
        const winners = [];
        for (const [a, b] of pairs) {
          const div = document.createElement('div');
          div.className = 'pair';
          const btnA = document.createElement('button');
          const btnB = document.createElement('button');
          btnA.className = 'card';
          btnB.className = 'card';
          btnA.innerHTML = `<div class="major">${a.major}</div><div class="friends">${a.friends}</div>`;
          btnB.innerHTML = `<div class="major">${b.major}</div><div class="friends">${b.friends}</div>`;
          div.appendChild(btnA); div.appendChild(btnB);

          document.getElementById('pair-container').innerHTML = '';
          document.getElementById('pair-container').appendChild(div);
          document.getElementById('tournament-screen').classList.remove('hidden');

          const winner = await new Promise(res => {
            btnA.onclick = () => res(a);
            btnB.onclick = () => res(b);
          });
          winners.push(winner);
        }
        resolve(winners);
      });
    }

    function showResults() {
      document.getElementById('tournament-screen').classList.add('hidden');
      document.getElementById('result-screen').classList.remove('hidden');

      const greeting = `${userInfo.school} ${userInfo.studentId} ${userInfo.name} 님이 선택한 결과입니다`;
      document.getElementById('greeting').innerText = greeting;

      const used = new Set();
      const resultRows = ['최종 선택', '결승', '4강', '8강'];
      const container = document.getElementById('results-tables');
      container.innerHTML = '';

      const table = document.createElement('table');

      resultRows.forEach(label => {
        const result = roundResults.find(r => r.roundName.includes(label));
        if (result) {
          const row = table.insertRow();
          row.insertCell().innerText = label;
          result.items.forEach(item => {
            if (!used.has(item.major)) {
              used.add(item.major);
              row.insertCell().innerText = item.major;
            }
          });
        }
      });

      container.appendChild(table);

      if (roundResults.length >= 6) {
        document.getElementById('pdfBtn').classList.remove('hidden');
      }
    }

    function repeatTournament() {
      document.getElementById('result-screen').classList.add('hidden');
      document.getElementById('info-screen').classList.remove('hidden');
    }

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text(`${userInfo.school} ${userInfo.studentId} ${userInfo.name} 님이 선택한 결과입니다`, 10, 10);
      let y = 20;
      roundResults.forEach(r => {
        doc.text(r.roundName, 10, y); y += 10;
        r.items.forEach(i => { doc.text(i.major, 10, y); y += 10; });
        y += 5;
      });
      doc.save('전공_월드컵_결과.pdf');
    }

    function shuffle(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }
  </script>
</body>
</html>
