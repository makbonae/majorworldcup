<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전공 이상형 월드컵</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-size: 24px; font-family: sans-serif; text-align: center; margin: 0; background: #f9f9f9; }
    .input-container, .instruction, .category-select, .tournament, .result-area, .round-loading { display: none; margin-top: 50px; }
    .category-select { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .bold-major { font-weight: bold; font-size: 48px; color: black; }
    .friend { color: pink; font-size: 18px; }
    .card-container { display: flex; justify-content: center; gap: 40px; flex-wrap: wrap; }
    .card { flex: 0 0 40%; border: 2px solid #ddd; border-radius: 20px; padding: 20px; cursor: pointer; background: white; }
    .loading { font-size: 36px; color: pink; margin-top: 200px; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid pink; border-radius: 50%; width: 80px; height: 80px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .summary-table { width: 80%; margin: 30px auto; border-collapse: collapse; font-size: 20px; }
    .summary-table th, .summary-table td { border: 1px solid #999; padding: 10px; }
  </style>
</head>
<body>

<div class="input-container" id="inputForm">
  <input id="school" placeholder="학교명">
  <input id="studentId" placeholder="학번">
  <input id="studentName" placeholder="이름">
  <button onclick="startInput()">다음</button>
</div>

<div class="instruction" id="instruction">
  <p style="text-align: left; padding-left: 1.5em; line-height: 1.6">
    ① 이 프로그램은 대학 전공학과에 대한 자신의 관심 순위를 알아보기 위해 제작되었습니다.<br>
    ② [인문+공통+체육], [자연+공통] 2개 카테고리 중 하나를 선택하여 진행합니다.<br>
    ③ 해당 계열의 전공학과가 쌍을 이루어 나타나면, 보다 관심이 있는 학과를 선택하기 바랍니다.<br>
    ④ 64강부터 시작하며, [인문+공통+체육]은 무작위로 선택된 8개의 학과가 부전승으로 32강에 진출합니다.<br>
    ⑤ 총 3번까지 결과를 저장하고 라운드를 진행할 수 있으며, 3라운드를 마치면 PDF 파일로 결과를 저장할 수 있습니다.<br>
    ⑥ 준비가 되었다면 아래 계열을 선택하고 전공학과 이상형 월드컵을 시작해 주세요.
  </p>
  <div class="category-select">
    <button onclick="loadMajorData('inmun')">인문+공통+체육</button>
    <button onclick="loadMajorData('jayeon')">자연+공통</button>
  </div>
</div>

<div class="round-loading" id="loading">
  <div class="spinner"></div>
  <div class="loading" id="loadingText"></div>
</div>

<div class="tournament" id="tournament"></div>
<div class="result-area" id="resultArea">
  <h2 id="resultHeader"></h2>
  <div id="summaryTree"></div>
  <button onclick="nextRound()">결과 저장하고 한번 더!</button>
  <button onclick="downloadPDF()" id="pdfBtn" style="display:none;">PDF 저장</button>
</div>

<script>
const SUPABASE_URL = 'https://vgnnzehkzbrsatdyoqzf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnbm56ZWhremJyc2F0ZHlvcXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzUyNTksImV4cCI6MjA2Njk1MTI1OX0.ANWPKzugvztZLkYm5P9og9ENF-SG4QcTi9s1RBOO1DA';
const client = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userInfo = {}, fullData = [], roundNum = 1, results = [];

function startInput() {
  userInfo = {
    school: document.getElementById('school').value.trim(),
    id: document.getElementById('studentId').value.trim(),
    name: document.getElementById('studentName').value.trim()
  };
  document.getElementById('inputForm').style.display = 'none';
  document.getElementById('instruction').style.display = 'block';
}

async function loadMajorData(category) {
  document.getElementById('instruction').style.display = 'none';
  const { data, error } = await client.from(category).select('*');
  if (error || !data) return alert('데이터 불러오기 실패');

  fullData = [...data];
  if (category === 'inmun') {
    fullData = shuffle(fullData);
    const advance = fullData.slice(0, 8);
    const round48 = fullData.slice(8, 56);
    const pairs = chunk(round48, 2);
    runTournament(pairs, advance);
  } else {
    fullData = shuffle(data).slice(0, 64);
    const pairs = chunk(fullData, 2);
    runTournament(pairs);
  }
}

function runTournament(pairs, advance = []) {
  document.getElementById('tournament').style.display = 'block';
  document.getElementById('loading').style.display = 'none';

  let selected = [], roundSize = pairs.length * 2;
  document.getElementById('tournament').innerHTML = `<h2>${roundSize}강</h2><div class="card-container" id="pairContainer"></div>`;
  const container = document.getElementById('pairContainer');

  let index = 0;
  function showPair() {
    if (index >= pairs.length) {
      let next = [...selected];
      if (advance.length > 0) next = [...next, ...advance];
      if (next.length === 1) {
        showResults(next[0]);
        return;
      }
      const nextPairs = chunk(next, 2);
      runTournament(nextPairs);
      return;
    }

    container.innerHTML = '';
    const pair = pairs[index];
    pair.forEach(item => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class='bold-major'>${item.major}</div><div class='friend'>${item.friends}</div>`;
      card.onclick = () => {
        selected.push(item);
        index++;
        setTimeout(showPair, 100);
      };
      container.appendChild(card);
    });
  }

  showPair();
}

function showResults(winner) {
  document.getElementById('tournament').style.display = 'none';
  document.getElementById('resultArea').style.display = 'block';
  document.getElementById('resultHeader').innerText = `${userInfo.school} ${userInfo.id} ${userInfo.name} 님이 선택한 결과입니다`;

  const summary = document.getElementById('summaryTree');
  results.push(winner);
  summary.innerHTML = '';
  results.forEach((win, i) => {
    summary.innerHTML += `
    <table class='summary-table'>
      <tr><th colspan='2'>Round ${i + 1} 결과</th></tr>
      <tr><th>최종 우승</th><td>${win.major}</td></tr>
      <tr><th>결승 진출자</th><td>${win.major_type || '-'}</td></tr>
      <tr><th>4강 진출자</th><td>${win['major-ref'] || '-'}</td></tr>
      <tr><th>8강 진출자</th><td>${win.desc || '-'}</td></tr>
    </table>`;
  });

  document.getElementById('pdfBtn').style.display = results.length >= 3 ? 'inline-block' : 'none';
}

function nextRound() {
  roundNum++;
  document.getElementById('resultArea').style.display = 'none';
  document.getElementById('summaryTree').innerHTML = '';
  document.getElementById('pdfBtn').style.display = 'none';
  document.getElementById('instruction').style.display = 'block';
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const fileName = `${userInfo.id}${userInfo.name}_전공월드컵결과.pdf`;

  html2canvas(document.body).then(canvas => {
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const pdf = new jsPDF();
    const imgProps = pdf.getImageProperties(imgData);
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
    pdf.save(fileName);
  });
}

function shuffle(array) {
  return array.sort(() => Math.random() - 0.5);
}

function chunk(arr, size) {
  const chunks = [];
  for (let i = 0; i < arr.length; i += size) chunks.push(arr.slice(i, i + size));
  return chunks;
}

window.onload = () => {
  document.getElementById('inputForm').style.display = 'block';
};
</script>
</body>
</html>
