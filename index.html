<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì „ê³µ ì´ìƒí˜• ì›”ë“œì»µ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
      text-align: center;
      font-size: 24px;
    }
    .hidden { display: none; }
    .input-container, .instruction, .category-select, .tournament, .result-area, .round-loading, .round-notice {
      margin-top: 50px;
    }
    .input-container input { font-size: 20px; padding: 8px; margin: 10px; }
    .card-container { display: flex; justify-content: center; gap: 40px; margin-top: 40px; }
    .card {
      flex: 1 1 30%;
      padding: 20px;
      border: 4px solid #ccc;
      border-radius: 20px;
      background: #fff;
      cursor: pointer;
      box-sizing: border-box;
      min-width: 200px;
    }
    .major {
      font-size: 48px;
      font-weight: bold;
      color: black;
    }
    .friends {
      font-size: 18px;
      color: hotpink;
    }
    .button { font-size: 24px; padding: 12px 24px; margin: 10px; }
    .summary-table {
      margin: 30px auto;
      border-collapse: collapse;
      font-size: 20px;
      width: 90%;
    }
    .summary-table th, .summary-table td {
      border: 1px solid #888;
      padding: 10px;
      text-align: center;
    }
    .spinner {
      border: 16px solid #f3f3f3;
      border-top: 16px solid pink;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="input-container" id="inputForm">
    <input id="school" placeholder="í•™êµ" />
    <input id="studentId" placeholder="í•™ë²ˆ" />
    <input id="studentName" placeholder="ì´ë¦„" />
    <button onclick="showInstructions()">ë‹¤ìŒ</button>
  </div>

  <div id="instruction" class="instruction hidden">
    <p style="text-align: left; padding-left: 1.5em; white-space: pre-line">
â‘  ì´ í”„ë¡œê·¸ë¨ì€ ëŒ€í•™ ì „ê³µí•™ê³¼ì— ëŒ€í•œ ìì‹ ì˜ ê´€ì‹¬ ìˆœìœ„ë¥¼ ì•Œì•„ë³´ê¸° ìœ„í•´ ì œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.
â‘¡ [ì¸ë¬¸+ê³µí†µ+ì²´ìœ¡], [ìì—°+ê³µí†µ] 2ê°œ ì¹´í…Œê³ ë¦¬ ì¤‘ì— í•˜ë‚˜ë¥¼ ì„ íƒí•˜ì—¬ ì§„í–‰í•©ë‹ˆë‹¤.
â‘¢ í•´ë‹¹ ê³„ì—´ì˜ ì „ê³µí•™ê³¼ê°€ ìŒì„ ì´ë£¨ì–´ ë‚˜íƒ€ë‚˜ë©´, ë³´ë‹¤ ê´€ì‹¬ì´ ìˆëŠ” í•™ê³¼ë¥¼ ì„ íƒí•˜ê¸° ë°”ëë‹ˆë‹¤.
â‘£ 64ê°•ë¶€í„° ì‹œì‘í•˜ë©°, [ì¸ë¬¸+ê³µí†µ+ì²´ìœ¡]ì€ ë¬´ì‘ìœ„ë¡œ ì„ íƒëœ 8ê°œì˜ í•™ê³¼ê°€ ë¶€ì „ìŠ¹ìœ¼ë¡œ 32ê°•ì— ì§„ì¶œí•©ë‹ˆë‹¤.
â‘¤ ì´ 3ë²ˆê¹Œì§€ ê²°ê³¼ë¥¼ ì €ì¥í•˜ê³  ë¼ìš´ë“œë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìœ¼ë©°, 3ë¼ìš´ë“œë¥¼ ë§ˆì¹˜ë©´ PDF íŒŒì¼ë¡œ ê²°ê³¼ë¥¼ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
â‘¥ ì¤€ë¹„ê°€ ë˜ì—ˆë‹¤ë©´ ì•„ë˜ ê³„ì—´ì„ ì„ íƒí•˜ê³  ì „ê³µí•™ê³¼ ì´ìƒí˜• ì›”ë“œì»µì„ ì‹œì‘í•´ ì£¼ì„¸ìš”.
    </p>
    <div class="category-select">
      <button onclick="startGame('inmun')" class="button">ì¸ë¬¸+ê³µí†µ+ì²´ìœ¡</button>
      <button onclick="startGame('jayeon')" class="button">ìì—°+ê³µí†µ</button>
    </div>
  </div>

  <div id="roundNotice" class="round-notice hidden">
    <div id="roundTitle" style="font-size: 48px; color: pink;"></div>
    <div class="spinner"></div>
  </div>

  <div id="tournament" class="tournament hidden"></div>

  <div id="resultArea" class="result-area hidden">
    <div id="summaryTree"></div>
    <button id="nextRoundBtn" class="button" onclick="nextRound()">ê²°ê³¼ ì €ì¥í•˜ê³  í•œë²ˆ ë”!</button>
    <button id="pdfBtn" class="button hidden" onclick="downloadPDF()">PDF ì €ì¥</button>
  </div>

<script>
const SUPABASE_URL = 'https://vgnnzehkzbrsatdyoqzf.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnbm56ZWhremJyc2F0ZHlvcXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzUyNTksImV4cCI6MjA2Njk1MTI1OX0.ANWPKzugvztZLkYm5P9og9ENF-SG4QcTi9s1RBOO1DA';
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let userInfo = { school: '', studentId: '', studentName: '' };
let results = [], currentTable = '', roundData = [], roundStages = {};

function showInstructions() {
  userInfo.school = document.getElementById('school').value.trim();
  userInfo.studentId = document.getElementById('studentId').value.trim();
  userInfo.studentName = document.getElementById('studentName').value.trim();
  if (!userInfo.school || !userInfo.studentId || !userInfo.studentName) {
    alert("ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”."); return;
  }
  document.getElementById("inputForm").classList.add("hidden");
  document.getElementById("instruction").classList.remove("hidden");
}

async function startGame(tableName) {
  currentTable = tableName;
  const { data, error } = await supabaseClient.from(tableName).select('*');
  if (error || !data || data.length === 0) {
    alert("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨"); return;
  }
  const majors = shuffleArray(data);
  if (tableName === 'inmun') {
    const bye = majors.slice(0, 8);
    roundData = majors.slice(8, 56);
    roundStages = { bye };
  } else {
    roundData = majors.slice(0, 64);
    roundStages = {};
  }
  results = [];
  document.getElementById("instruction").classList.add("hidden");
  nextStage();
}

function nextStage() {
  const total = roundData.length + (roundStages.bye ? roundStages.bye.length : 0);

  // ğŸ”½ ì´ì „ í™”ë©´ ì‚¬ë¼ì§€ê²Œ ì²˜ë¦¬
  document.getElementById("tournament").classList.add("hidden");

  document.getElementById("roundTitle").innerText = `${total}ê°• ë¡œë”© ì¤‘...`;
  document.getElementById("roundNotice").classList.remove("hidden");

  setTimeout(() => {
    document.getElementById("roundNotice").classList.add("hidden");
    document.getElementById("tournament").classList.remove("hidden");
    runMatch(roundData, roundStages.bye || []);
    roundStages.bye = [];
  }, 1500);
}

function runMatch(data, bye) {
  const container = document.getElementById("tournament");
  container.innerHTML = "";
  const pairs = [];
  for (let i = 0; i < data.length; i += 2) pairs.push([data[i], data[i + 1]]);
  let selected = [];
  function showPair(index) {
    if (index >= pairs.length) {
      roundData = [...selected, ...bye];
      if (roundData.length === 1) {
        recordResult(roundData[0]);
        return showResults();
      }
      nextStage();
      return;
    }
    const [a, b] = pairs[index];
    container.innerHTML = '';
    const row = document.createElement('div');
    row.className = 'card-container';
    [a, b].forEach(cardData => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `<div class='major'>${cardData.major}</div><div class='friends'>${cardData.friends}</div>`;
      card.onclick = () => { selected.push(cardData); showPair(index + 1); };
      row.appendChild(card);
    });
    container.appendChild(row);
  }
  showPair(0);
}

function recordResult(finalWinner) {
  const final = finalWinner;
  const finals = roundData.filter(item => item !== final).slice(0, 1);
  const finalsSet = new Set([final.id, ...finals.map(f => f.id)]);

  const semis = roundResults.at(-1) || [];
  const semisOnly = semis.filter(item => !finalsSet.has(item.id)).slice(0, 2);
  const semisSet = new Set(semis.map(s => s.id));

  const quarters = roundResults.at(-2) || [];
  const quartersOnly = quarters.filter(item => !semisSet.has(item.id)).slice(0, 4);

  results.push({
    final: final.major,
    finals: finals.map(f => f.major),
    semis: semisOnly.map(s => s.major),
    quarters: quartersOnly.map(q => q.major)
  });
}

function showResults() {
  document.getElementById("tournament").classList.add("hidden");
  document.getElementById("resultArea").classList.remove("hidden");
  const tree = document.getElementById("summaryTree");
  tree.innerHTML = `<h2>${userInfo.school} ${userInfo.studentId} ${userInfo.studentName} ë‹˜ì˜ ì„ íƒ ê²°ê³¼</h2>`;
  results.forEach((r, i) => {
    tree.innerHTML += `
    <table class='summary-table'>
      <tr><th colspan='2'>Round ${i + 1} ê²°ê³¼</th></tr>
      <tr><th>ìµœì¢… ìš°ìŠ¹</th><td>${r.final}</td></tr>
      <tr><th>ê²°ìŠ¹ ì§„ì¶œì</th><td>${r.finals.map(f => f.major || f).join(" / ")}</td></tr>
      <tr><th>4ê°• ì§„ì¶œì</th><td>${r.semis.map(s => s.major || s).join(" / ")}</td></tr>
      <tr><th>8ê°• ì§„ì¶œì</th><td>${r.quarters.map(q => q.major || q).join(" / ")}</td></tr>
    </table>`;
  });
  document.getElementById("pdfBtn").classList.toggle("hidden", results.length < 3);
  document.getElementById("nextRoundBtn").classList.toggle("hidden", results.length >= 3);
}

function nextRound() {
  roundData = [];
  roundStages = {};
  document.getElementById("resultArea").classList.add("hidden");
  document.getElementById("pdfBtn").classList.add("hidden");
  document.getElementById("nextRoundBtn").classList.add("hidden");
  startGame(currentTable);
}

function shuffleArray(arr) {
  return arr.map(v => [Math.random(), v]).sort((a, b) => a[0] - b[0]).map(v => v[1]);
}

function downloadPDF() {
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF();
  pdf.html(document.body, {
    callback: function(doc) {
      doc.save(`${userInfo.studentId}_${userInfo.studentName}_ê²°ê³¼.pdf`);
    }, x: 10, y: 10
  });
}
</script>
</body>
</html>
