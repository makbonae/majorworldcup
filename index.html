<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>전공 이상형 월드컵</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-size: 24px; font-family: sans-serif; text-align: center; margin: 0; background: #f9f9f9; }
    .input-container, .instruction, .tournament, .result-area, .round-loading { display: none; margin-top: 50px; }
    .category-select { display: flex; justify-content: center; gap: 20px; margin-top: 20px; }
    .bold-major { font-weight: bold; font-size: 48px; color: black; }
    .friend-text { font-size: 24px; color: blue; margin-top: 10px; }
    .spinner { border: 8px solid #f3f3f3; border-top: 8px solid #555; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: auto; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    table { margin: auto; border-collapse: collapse; margin-top: 20px; }
    td { border: 1px solid #ccc; padding: 10px 20px; }
    button { font-size: 24px; margin: 10px; padding: 10px 20px; }
    .card { display: inline-block; width: 40%; margin: 20px; padding: 30px; border: 2px solid #aaa; border-radius: 10px; background: white; cursor: pointer; }
  </style>
</head>
<body>
  <div class="input-container" id="inputForm">
    <input id="school" placeholder="학교명">
    <input id="student_id" placeholder="학번">
    <input id="student_name" placeholder="이름">
    <button onclick="showInstruction()">다음</button>
  </div>

  <div class="instruction" id="instruction">
    <p>① 이 프로그램은 대학 전공학과에 대한 자신의 관심 순위를 알아보기 위해 제작되었습니다.<br>
    ② [인문+공통+체육], [자연+공통] 2개 카테고리 중 하나를 선택하여 진행합니다.<br>
    ③ 해당 계열의 전공학과가 쌍을 이루어 나타나면, 보다 관심이 있는 학과를 선택해 주세요.<br>
    ④ 64강부터 시작하며, [인문+공통+체육]은 무작위로 선택된 8개의 학과가 부전승으로 32강에 진출합니다.<br>
    ⑤ 총 3번까지 결과를 저장하고 라운드를 반복할 수 있으며, 3라운드를 마치면 PDF로 저장할 수 있습니다.</p>
    <div class="category-select">
      <button onclick="startCategory('inmun')">인문+공통+체육</button>
      <button onclick="startCategory('jayeon')">자연+공통</button>
    </div>
  </div>

  <div class="round-loading" id="roundLoading">
    <div class="spinner"></div>
    <p id="roundText"></p>
  </div>

  <div class="tournament" id="tournament"></div>
  <div class="result-area" id="resultArea"></div>
  <div id="repeatButton"></div>
  <div id="pdfButton"></div>

  <script>
    const SUPABASE_URL = 'https://vgnnzehkzbrsatdyoqzf.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZnbm56ZWhremJyc2F0ZHlvcXpmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTEzNzUyNTksImV4cCI6MjA2Njk1MTI1OX0.ANWPKzugvztZLkYm5P9og9ENF-SG4QcTi9s1RBOO1DA';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let roundData = [];
    let currentRound = 1;
    const maxRounds = 3;
    let userInfo = {};
    let selectedCategory = '';
    const roundResults = [];

    document.getElementById('inputForm').style.display = 'block';

    function showInstruction() {
      userInfo.school = document.getElementById('school').value;
      userInfo.id = document.getElementById('student_id').value;
      userInfo.name = document.getElementById('student_name').value;
      document.getElementById('inputForm').style.display = 'none';
      document.getElementById('instruction').style.display = 'block';
    }

    async function startCategory(table) {
      selectedCategory = table;
      document.getElementById('instruction').style.display = 'none';
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('repeatButton').style.display = 'none';
      document.getElementById('pdfButton').style.display = 'none';
      showLoading('64강');

      let { data, error } = await supabase.from(table).select('*');
      if (error || !data || data.length < 64) return alert('데이터 불러오기 실패 또는 데이터 부족');

      data = shuffleArray(data);
      roundData = [];

      if (table === 'inmun') {
        if (data.length < 56) return alert('인문 계열은 최소 56개의 학과가 필요합니다.');
        const autoPass = data.slice(0, 8);
        const round64Set = data.slice(8, 56);
        const round64Winners = [];
        let index = 0;

        function play64Round() {
          if (index >= round64Set.length) {
            roundData = [...round64Winners, ...autoPass];
            showLoading('32강');
            setTimeout(() => {
              hideLoading();
              document.getElementById('tournament').style.display = 'block';
              playRound(roundData);
            }, 2000);
            return;
          }
          const card1 = round64Set[index];
          const card2 = round64Set[index + 1];
          index += 2;
          const container = document.getElementById('tournament');
          container.innerHTML = '';
          const cardA = createCard(card1);
          const cardB = createCard(card2);
          cardA.onclick = () => { round64Winners.push(card1); play64Round(); };
          cardB.onclick = () => { round64Winners.push(card2); play64Round(); };
          container.appendChild(cardA);
          container.appendChild(cardB);
        }

        hideLoading();
        document.getElementById('tournament').style.display = 'block';
        play64Round();
      } else {
        roundData = data.slice(0, 64);
        setTimeout(() => {
          hideLoading();
          document.getElementById('tournament').style.display = 'block';
          playRound(roundData);
        }, 2000);
      }
    }

    function playRound(pairs) {
      const container = document.getElementById('tournament');
      container.innerHTML = '';
      if (pairs.length === 1) {
        saveRoundResult(pairs[0]);
        showSummary();
        return;
      }
      const nextRound = [];
      let currentPairIndex = 0;

      function showPair() {
        if (currentPairIndex >= pairs.length) {
          const nextLabel = getNextRoundLabel(nextRound.length);
          showLoading(nextLabel);
          setTimeout(() => {
            hideLoading();
            roundData = nextRound;
            playRound(nextRound);
          }, 2000);
          return;
        }
        const card1 = pairs[currentPairIndex];
        const card2 = pairs[currentPairIndex + 1];
        currentPairIndex += 2;
        container.innerHTML = '';
        const cardA = createCard(card1);
        const cardB = createCard(card2);
        cardA.onclick = () => { nextRound.push(card1); showPair(); };
        cardB.onclick = () => { nextRound.push(card2); showPair(); };
        container.appendChild(cardA);
        container.appendChild(cardB);
      }

      showPair();
    }

    function getNextRoundLabel(count) {
      const map = {32:'16강', 16:'8강', 8:'4강', 4:'2강', 2:'1강'};
      return map[count] || `${count}강`;
    }

    function showLoading(roundName) {
      document.getElementById('roundLoading').style.display = 'block';
      document.getElementById('tournament').style.display = 'none';
      let displayName = roundName === '2강' ? '결승' : roundName;
      if (roundName === '1강') displayName = `${userInfo.name} 님의 선택 결과입니다.`;
      else displayName += ' 로딩중...';
      document.getElementById('roundText').innerText = displayName;
    }

    function hideLoading() {
      document.getElementById('roundLoading').style.display = 'none';
    }

    function shuffleArray(arr) {
      return arr.sort(() => Math.random() - 0.5);
    }

    function createCard(item) {
      const div = document.createElement('div');
      div.className = 'card';
      div.innerHTML = `<div class='bold-major'>${item.major}</div><div class='friend-text'>${item.friends}</div>`;
      return div;
    }

    function saveRoundResult(winner) {
      const result = {
        final: winner,
        semis: roundData.length === 2 ? [...roundData] : [],
        quarters: roundData.length === 4 ? [...roundData] : [],
      };
      roundResults[currentRound - 1] = result;
    }

    function showSummary() {
      document.getElementById('tournament').style.display = 'none';
      const result = document.getElementById('resultArea');
      result.style.display = 'block';

      let html = `<p>${userInfo.school} ${userInfo.id} ${userInfo.name} 님이 선택한 결과입니다</p>`;
      for (let i = 0; i < roundResults.length; i++) {
        const res = roundResults[i];
        const final = res.final.major;
        const finals = res.semis.filter(x => x.major !== final).map(x => x.major);
        const semis = res.quarters.filter(x => !res.semis.includes(x)).map(x => x.major);
        const quarters = res.quarters.filter(x => ![final, ...finals, ...semis].includes(x.major)).map(x => x.major);

        html += `<h3>Round ${i + 1}</h3><table>`;
        html += `<tr><td>최종선택</td><td>${final}</td></tr>`;
        html += `<tr><td>결승진출</td><td>${finals.join(', ')}</td></tr>`;
        html += `<tr><td>4강진출</td><td>${semis.join(', ')}</td></tr>`;
        html += `<tr><td>8강진출</td><td>${quarters.join(', ')}</td></tr>`;
        html += `</table>`;
      }
      result.innerHTML = html;

      if (currentRound < maxRounds) {
        document.getElementById('repeatButton').innerHTML = '<button onclick="repeatRound()">결과 저장하고 한번 더!</button>';
        document.getElementById('repeatButton').style.display = 'block';
      } else {
        document.getElementById('pdfButton').innerHTML = '<button onclick="downloadPDF()">PDF 저장</button>';
        document.getElementById('pdfButton').style.display = 'block';
      }
    }

    function repeatRound() {
      currentRound++;
      roundData = [];
      document.getElementById('resultArea').style.display = 'none';
      startCategory(selectedCategory);
    }

    function downloadPDF() {
      const element = document.getElementById('resultArea');
      html2canvas(element, { scale: 2 }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(`${userInfo.id}_${userInfo.name}_이상형월드컵결과.pdf`);
      });
    }
  </script>
</body>
</html>
